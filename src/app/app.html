<div class="app__container">
  <!-- Left Sidebar - Notes Navigation -->
  <div class="sidebar sidebar--left" [class.sidebar--collapsed]="leftSidebarCollapsed()">
    <div class="sidebar__header">
      <h2 class="sidebar__title" *ngIf="!leftSidebarCollapsed()">Notes</h2>
      <button class="btn btn--collapse" (click)="toggleLeftSidebar()">
        <svg viewBox="0 0 24 24" width="16" height="16" [style.transform]="leftSidebarCollapsed() ? 'rotate(180deg)' : 'rotate(0deg)'">
          <path fill="currentColor" d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
        </svg>
      </button>
    </div>
    <div class="sidebar__content" *ngIf="!leftSidebarCollapsed()">
      <div class="search-box">
        <input class="input input--search" type="text" placeholder="Search notes..." [(ngModel)]="searchQuery">
      </div>
      <div class="notes__list">
        @for (note of filteredNotes(); track note.id) {
          <div class="note__item" 
               [class.note__item--active]="selectedNote()?.id === note.id"
               (click)="selectNote(note)">
            <div class="note__title">{{ note.title }}</div>
            <div class="note__preview">{{ note.preview }}</div>
            <div class="note__date">{{ note.lastModified | date:'short' }}</div>
          </div>
        }
      </div>
      <button class="btn btn--new-note" (click)="createNewNote()">
        <svg viewBox="0 0 24 24" width="16" height="16">
          <path fill="currentColor" d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
        </svg>
        New Note
      </button>
    </div>
  </div>

  <!-- Main Content - Note Editor -->
  <div class="main-content">
    <div class="editor__header">
      @if (selectedNote()) {
        <div class="editor__header-content">
          <input type="text" 
                 class="input input--title" 
                 [(ngModel)]="selectedNote()!.title" 
                 placeholder="Note title...">
          <div class="editor__controls">
            <button class="btn btn--preview-toggle" 
                    (click)="toggleMarkdownPreview()"
                    [class.btn--preview-toggle--active]="showMarkdownPreview()">
              <svg viewBox="0 0 24 24" width="16" height="16">
                <path fill="currentColor" d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
              </svg>
              {{ showMarkdownPreview() ? 'Edit' : 'Preview' }}
            </button>
          </div>
        </div>
      } @else {
        <div class="welcome-message">
          <h1 class="welcome-message__title">Welcome to Neural Notes</h1>
          <p class="welcome-message__text">Select a note from the sidebar or create a new one to get started.</p>
        </div>
      }
    </div>
    <div class="editor__content">
      @if (selectedNote()) {
        @if (showMarkdownPreview()) {
          <div class="markdown-preview" [innerHTML]="markdownPreview()"></div>
        } @else {
          <div class="line-editor">
            @for (line of selectedNote()!.lines; track $index) {
              @if (shouldRenderLine()($index)) {
                <!-- Rendered markdown view -->
                <div 
                  class="rendered-line"
                  [attr.data-line-index]="$index"
                  [innerHTML]="renderLineMarkdown(line)"
                  (click)="handleRenderedLineClick($index, $event)">
                </div>
              } @else {
                <!-- Editable text view -->
                <div 
                  class="editor__line"
                  contenteditable="true"
                  [attr.data-line-index]="$index"
                  [textContent]="line"
                  (input)="updateLine($index, $any($event.target).textContent || '')"
                  (keydown)="handleLineKeydown($event, $index)"
                  (focus)="handleLineFocus($index)"
                  (blur)="handleLineBlur($index)">
                </div>
              }
            }
            @if (selectedNote()!.lines.length === 0) {
              <div 
                class="editor__line editor__line--placeholder"
                contenteditable="true"
                [attr.data-line-index]="0"
                (input)="updateLine(0, $any($event.target).textContent || '')"
                (keydown)="handleLineKeydown($event, 0)"
                (focus)="handleLineFocus(0)"
                (blur)="handleLineBlur(0)"
                data-placeholder="Start writing your note with **markdown**...">
              </div>
            }
          </div>
          
          <!-- Backlink Suggestions -->
          @if (showBacklinkSuggestions()) {
            <div class="backlink-suggestions">
              <div class="suggestions__header">Link to note:</div>
              @for (suggestion of backlinkSuggestions(); track suggestion.id) {
                <div class="suggestion__item" (click)="insertBacklinkSuggestion(suggestion)">
                  <div class="suggestion__title">{{ suggestion.title }}</div>
                  <div class="suggestion__preview">{{ suggestion.preview }}</div>
                </div>
              }
            </div>
          }
        }
      }
    </div>
  </div>

  <!-- Right Sidebar - AI Chat -->
  <div class="sidebar sidebar--right" [class.sidebar--collapsed]="rightSidebarCollapsed()">
    <div class="sidebar__header">
      <button class="btn btn--collapse" (click)="toggleRightSidebar()">
        <svg viewBox="0 0 24 24" width="16" height="16" [style.transform]="rightSidebarCollapsed() ? 'rotate(180deg)' : 'rotate(0deg)'">
          <path fill="currentColor" d="M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z"/>
        </svg>
      </button>
      <h2 class="sidebar__title" *ngIf="!rightSidebarCollapsed()">AI Assistant</h2>
    </div>
    <div class="sidebar__content" *ngIf="!rightSidebarCollapsed()">
      <div class="chat__messages">
        @for (message of chatMessages(); track message.id) {
          <div class="message" [class]="'message--' + message.sender">
            <div class="message__content">{{ message.content }}</div>
            <div class="message__time">{{ message.timestamp | date:'short' }}</div>
          </div>
        }
      </div>
      <div class="chat__input">
        <textarea 
          class="textarea textarea--chat"
          [(ngModel)]="chatInput" 
          placeholder="Ask AI about your notes..."
          (keydown.enter)="sendMessage($event)"></textarea>
        <button class="btn btn--send" 
                [class.btn--send--disabled]="!chatInput().trim()"
                (click)="sendMessage()" 
                [disabled]="!chatInput().trim()">
          <svg viewBox="0 0 24 24" width="16" height="16">
            <path fill="currentColor" d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
          </svg>
        </button>
      </div>
    </div>
  </div>
</div>

<router-outlet />